# 数据库迁移完成 - 测试指南

## ✅ 已完成的工作

所有代码已更新以适配您的新数据库结构！更新的文件包括：

1. ✅ **search.php** - 搜索功能
2. ✅ **get_enzyme_detail.php** - 酶详情API
3. ✅ **detail.php** - 详情页API
4. ✅ **stats.php** - 统计信息API
5. ✅ **api_dataset_stats.php** - 数据集统计
6. ✅ **api_protein_structure.php** - 3D结构API
7. ✅ **export_sequences.php** - 序列导出工具
8. ✅ **interactive_tree.php** - 系统发育树页面
9. ✅ **blast_search.php** - BLAST搜索

## 🎯 核心改进

### 数据库字段适配
- ❌ 移除了旧的 `plastic` 和 `label` 字段引用
- ✅ 使用新的 `can_degrade_*` 字段（50+ 种塑料类型）
- ✅ 支持 `predicted_ec_number` 和 `ec_prediction_source` 字段

### 向后兼容性
虽然数据库结构改变了，但所有API仍然返回 `plastic` 字段，这是通过以下方式实现的：
- 动态聚合所有 `can_degrade_*` = 1 的字段
- 生成格式如 "PET, PLA, PCL" 的字符串
- **前端V9.html无需任何修改！**

## 📋 快速测试步骤

### 第1步：运行自动化测试
在浏览器中访问：
```
http://localhost/plaszymedb/test_new_schema.php
```

这个页面会自动测试：
- ✓ 数据库连接
- ✓ 表结构验证
- ✓ 数据统计
- ✓ 塑料降解能力分布
- ✓ 所有API端点链接

### 第2步：测试前端主页
访问：
```
http://localhost/plaszymedb/V9.html
```

测试以下功能：
- [ ] 页面能正常加载
- [ ] 搜索框功能正常
- [ ] 塑料类型筛选下拉菜单正常
- [ ] EC编号筛选正常
- [ ] 宿主生物筛选正常
- [ ] 搜索结果能正常显示
- [ ] 点击结果能查看详情页

### 第3步：测试搜索功能
在浏览器中测试以下URL：

**基本搜索：**
```
http://localhost/plaszymedb/search.php
```

**带关键词搜索：**
```
http://localhost/plaszymedb/search.php?search=enzyme
```

**塑料类型筛选：**
```
http://localhost/plaszymedb/search.php?plastic=PET
```

### 第4步：测试详情页
获取一个PLZ_ID（从搜索结果中），然后访问：
```
http://localhost/plaszymedb/get_enzyme_detail.php?plz_id=YOUR_PLZ_ID
```

或者：
```
http://localhost/plaszymedb/detail.php?plz_id=YOUR_PLZ_ID
```

### 第5步：测试统计功能
```
http://localhost/plaszymedb/stats.php
```

应该能看到：
- 总酶数量
- 塑料类型数量
- 唯一序列数量
- 3D结构数量
- 塑料类型分布（按新字段统计）
- 宿主生物分布
- EC编号分布

### 第6步：测试PHYLOGENY页面
```
http://localhost/plaszymedb/api_dataset_stats.php
```

应该显示各数据集的统计信息。

## 🔍 常见问题排查

### 问题1: "plastic字段不存在"错误
**原因：** 数据库中确实没有plastic字段了
**解决：** 这是正常的！所有PHP文件已更新，会动态生成plastic字段

### 问题2: API返回空结果
**检查：**
1. 数据库中是否有数据？
2. `can_degrade_*` 字段是否有值为1的记录？
3. 查看 `test_new_schema.php` 的统计数据

### 问题3: 塑料类型筛选不工作
**检查：**
1. 使用的塑料类型名称是否正确（如 PET, PE, PLA）
2. 数据库中对应的 `can_degrade_PET` 等字段是否有数据

### 问题4: 前端显示"N/A"
**原因：** 该酶没有任何 `can_degrade_*` 字段为1
**解决：** 检查数据库数据是否正确导入

## 📊 数据验证SQL查询

在MariaDB中运行这些查询来验证数据：

```sql
-- 检查总记录数
SELECT COUNT(*) FROM plaszymedb;

-- 检查有多少酶可以降解PET
SELECT COUNT(*) FROM plaszymedb WHERE can_degrade_PET = 1;

-- 检查有多少酶可以降解PE
SELECT COUNT(*) FROM plaszymedb WHERE can_degrade_PE = 1;

-- 查看某个酶的所有降解能力
SELECT PLZ_ID, enzyme_name, 
       can_degrade_PET, can_degrade_PE, can_degrade_PLA, 
       can_degrade_PCL, can_degrade_PBS, can_degrade_PBAT
FROM plaszymedb 
LIMIT 5;

-- 检查哪些塑料类型有数据
SELECT 
    SUM(can_degrade_PET) as PET_count,
    SUM(can_degrade_PE) as PE_count,
    SUM(can_degrade_PLA) as PLA_count,
    SUM(can_degrade_PCL) as PCL_count,
    SUM(can_degrade_PBS) as PBS_count,
    SUM(can_degrade_PBAT) as PBAT_count,
    SUM(can_degrade_PHB) as PHB_count,
    SUM(can_degrade_PU) as PU_count
FROM plaszymedb;
```

## 🚀 性能优化建议

如果您的数据库记录很多（>1000条），建议添加索引：

```sql
-- 添加主键（如果还没有）
ALTER TABLE plaszymedb ADD PRIMARY KEY (PLZ_ID);

-- 添加常用查询字段的索引
CREATE INDEX idx_ec_number ON plaszymedb(ec_number);
CREATE INDEX idx_taxonomy ON plaszymedb(taxonomy);
CREATE INDEX idx_host_organism ON plaszymedb(host_organism);

-- 添加常用塑料类型的索引
CREATE INDEX idx_can_degrade_PET ON plaszymedb(can_degrade_PET);
CREATE INDEX idx_can_degrade_PE ON plaszymedb(can_degrade_PE);
CREATE INDEX idx_can_degrade_PLA ON plaszymedb(can_degrade_PLA);
```

## ✅ 测试检查清单

完成以下检查后，您的迁移就成功了！

- [ ] ✓ 运行 test_new_schema.php，所有测试通过
- [ ] ✓ V9.html 主页能正常加载
- [ ] ✓ 搜索功能正常工作
- [ ] ✓ 塑料类型筛选功能正常
- [ ] ✓ 详情页能正常显示
- [ ] ✓ 统计页面数据正确
- [ ] ✓ 3D结构查看器正常（如果有PDB文件）
- [ ] ✓ BLAST搜索正常（如果使用）
- [ ] ✓ 系统发育树页面正常（如果使用）

## 📝 需要帮助？

如果遇到任何问题：

1. **查看错误日志：** 在 `config.php` 中已启用错误显示
2. **检查数据库连接：** 确认 `db_config.php` 中的密码正确
3. **运行测试脚本：** `test_new_schema.php` 会提供详细的诊断信息
4. **检查浏览器控制台：** 按F12查看JavaScript错误
5. **查看数据库数据：** 确保 `can_degrade_*` 字段有正确的数据

## 🎉 恭喜！

您的PlaszymeDB已成功迁移到新的数据库架构！

所有功能应该都能正常工作了。祝您使用愉快！

