<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è›‹ç™½è´¨3Dç»“æ„æŸ¥çœ‹å™¨æµ‹è¯• - PlaszymeDB</title>
    
    <!-- Mol* Library -->
    <script src="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.css">
    
    <!-- è›‹ç™½è´¨3Dç»“æ„æŸ¥çœ‹å™¨ -->
    <script src="protein_3d_viewer.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #005eb8;
            margin-bottom: 15px;
        }
        .test-controls {
            margin-bottom: 20px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9em;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #e9ecef;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .viewer-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        .input-group label {
            font-weight: bold;
            min-width: 80px;
        }
        .input-group input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¬ è›‹ç™½è´¨3Dç»“æ„æŸ¥çœ‹å™¨æµ‹è¯•</h1>
        
        <!-- åŸºç¡€åŠŸèƒ½æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">1. åŸºç¡€åŠŸèƒ½æµ‹è¯•</div>
            <div class="test-controls">
                <button class="btn" onclick="testLibraryLoad()">æ£€æŸ¥Mol*åº“</button>
                <button class="btn" onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
                <button class="btn success" onclick="initViewer()">åˆå§‹åŒ–æŸ¥çœ‹å™¨</button>
                <button class="btn danger" onclick="destroyViewer()">é”€æ¯æŸ¥çœ‹å™¨</button>
            </div>
            <div class="status" id="basic-status">å‡†å¤‡å°±ç»ª</div>
        </div>

        <!-- ç»“æ„åŠ è½½æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">2. ç»“æ„åŠ è½½æµ‹è¯•</div>
            <div class="test-controls">
                <div class="input-group">
                    <label>PLZ_ID:</label>
                    <input type="text" id="plz-input" value="00d4a4bfbe" placeholder="è¾“å…¥PLZ_ID">
                    <button class="btn success" onclick="loadTestStructure()">åŠ è½½é¢„æµ‹ç»“æ„</button>
                    <button class="btn warning" onclick="loadExperimentalStructure()">åŠ è½½å®éªŒç»“æ„</button>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="loadStructure('008a870d80')">æµ‹è¯• 008a870d80</button>
                    <button class="btn" onclick="loadStructure('00fab94b93')">æµ‹è¯• 00fab94b93</button>
                    <button class="btn" onclick="loadStructure('01681a8b2b')">æµ‹è¯• 01681a8b2b</button>
                </div>
            </div>
            <div class="status" id="load-status">ç­‰å¾…åŠ è½½ç»“æ„</div>
        </div>

        <!-- æŸ¥çœ‹å™¨æ§åˆ¶æµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">3. æŸ¥çœ‹å™¨æ§åˆ¶æµ‹è¯•</div>
            <div class="test-controls">
                <button class="btn" onclick="testRepresentation('cartoon')">å¡é€šæ¨¡å¼</button>
                <button class="btn" onclick="testRepresentation('surface')">è¡¨é¢æ¨¡å¼</button>
                <button class="btn" onclick="testRepresentation('ball-stick')">çƒæ£æ¨¡å¼</button>
                <button class="btn" onclick="testResetView()">é‡ç½®è§†å›¾</button>
                <button class="btn" onclick="testDownloadPDB()">ä¸‹è½½PDB</button>
                <button class="btn" onclick="testDownloadImage()">ä¸‹è½½å›¾ç‰‡</button>
            </div>
            <div class="status" id="control-status">ç­‰å¾…æµ‹è¯•æ§åˆ¶åŠŸèƒ½</div>
        </div>

        <!-- 3Dç»“æ„æŸ¥çœ‹å™¨å®¹å™¨ -->
        <div class="viewer-container">
            <div id="protein-viewer-test" style="height: 600px;">
                <!-- æŸ¥çœ‹å™¨å°†åœ¨è¿™é‡Œåˆå§‹åŒ– -->
            </div>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="test-section">
            <div class="test-title">4. æµ‹è¯•æ—¥å¿—</div>
            <button class="btn danger" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <div class="log" id="test-log"></div>
        </div>
    </div>

    <script>
        let testViewer = null;
        
        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(elementId, message, type = '') {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
        }
        
        // æµ‹è¯•Mol*åº“åŠ è½½
        function testLibraryLoad() {
            log('æµ‹è¯•Mol*åº“åŠ è½½çŠ¶æ€...');
            updateStatus('basic-status', 'æ£€æŸ¥Mol*åº“...', 'loading');
            
            if (typeof window.molstar !== 'undefined') {
                log('âœ… Mol*åº“å·²åŠ è½½');
                updateStatus('basic-status', 'Mol*åº“å·²åŠ è½½', 'success');
            } else {
                log('âŒ Mol*åº“æœªåŠ è½½');
                updateStatus('basic-status', 'Mol*åº“æœªåŠ è½½', 'error');
            }
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testAPIConnection() {
            log('æµ‹è¯•APIè¿æ¥...');
            updateStatus('basic-status', 'æµ‹è¯•APIè¿æ¥...', 'loading');
            
            try {
                const response = await fetch('api_protein_structure.php?plz_id=test&action=info');
                const data = await response.json();
                
                log(`âœ… APIè¿æ¥æ­£å¸¸: ${JSON.stringify(data)}`);
                updateStatus('basic-status', 'APIè¿æ¥æ­£å¸¸', 'success');
            } catch (error) {
                log(`âŒ APIè¿æ¥å¤±è´¥: ${error.message}`);
                updateStatus('basic-status', 'APIè¿æ¥å¤±è´¥', 'error');
            }
        }
        
        // åˆå§‹åŒ–æŸ¥çœ‹å™¨
        async function initViewer() {
            try {
                log('åˆå§‹åŒ–3Dç»“æ„æŸ¥çœ‹å™¨...');
                updateStatus('basic-status', 'åˆå§‹åŒ–æŸ¥çœ‹å™¨...', 'loading');
                
                if (testViewer) {
                    testViewer.destroy();
                    testViewer = null;
                }
                
                testViewer = new ProteinStructureViewer('protein-viewer-test', {
                    onLoadStart: (plzId, dataType) => {
                        log(`å¼€å§‹åŠ è½½ç»“æ„: ${plzId} (${dataType})`);
                        updateStatus('load-status', `åŠ è½½ä¸­: ${plzId}`, 'loading');
                    },
                    onLoadComplete: (plzId, dataType, data) => {
                        log(`âœ… ç»“æ„åŠ è½½å®Œæˆ: ${plzId} (${dataType})`);
                        updateStatus('load-status', `åŠ è½½å®Œæˆ: ${plzId}`, 'success');
                    },
                    onLoadError: (plzId, dataType, error) => {
                        log(`âŒ ç»“æ„åŠ è½½å¤±è´¥: ${plzId} (${dataType}) - ${error.message}`);
                        updateStatus('load-status', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    },
                    onInit: (viewer) => {
                        log('âœ… 3Dç»“æ„æŸ¥çœ‹å™¨åˆå§‹åŒ–å®Œæˆ');
                        updateStatus('basic-status', 'æŸ¥çœ‹å™¨å·²åˆå§‹åŒ–', 'success');
                    }
                });
                
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                updateStatus('basic-status', 'åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }
        
        // é”€æ¯æŸ¥çœ‹å™¨
        function destroyViewer() {
            if (testViewer) {
                testViewer.destroy();
                testViewer = null;
                log('æŸ¥çœ‹å™¨å·²é”€æ¯');
                updateStatus('basic-status', 'æŸ¥çœ‹å™¨å·²é”€æ¯', '');
            } else {
                log('æ²¡æœ‰æ´»åŠ¨çš„æŸ¥çœ‹å™¨');
            }
        }
        
        // åŠ è½½æµ‹è¯•ç»“æ„
        async function loadTestStructure() {
            const plzId = document.getElementById('plz-input').value.trim();
            if (!plzId) {
                alert('è¯·è¾“å…¥PLZ_ID');
                return;
            }
            await loadStructure(plzId, 'predicted');
        }
        
        // åŠ è½½å®éªŒç»“æ„
        async function loadExperimentalStructure() {
            const plzId = document.getElementById('plz-input').value.trim();
            if (!plzId) {
                alert('è¯·è¾“å…¥PLZ_ID');
                return;
            }
            await loadStructure(plzId, 'experimental');
        }
        
        // åŠ è½½ç»“æ„
        async function loadStructure(plzId, dataType = 'predicted') {
            if (!testViewer) {
                log('âŒ æŸ¥çœ‹å™¨æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆåˆå§‹åŒ–');
                updateStatus('load-status', 'æŸ¥çœ‹å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                log(`åŠ è½½ç»“æ„: ${plzId} (${dataType})`);
                await testViewer.loadStructure(plzId, dataType);
            } catch (error) {
                log(`âŒ åŠ è½½ç»“æ„å¤±è´¥: ${error.message}`);
                updateStatus('load-status', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•è¡¨ç¤ºæ–¹å¼
        async function testRepresentation(repr) {
            if (!testViewer) {
                log('âŒ æŸ¥çœ‹å™¨æœªåˆå§‹åŒ–');
                updateStatus('control-status', 'æŸ¥çœ‹å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            try {
                log(`è®¾ç½®è¡¨ç¤ºæ–¹å¼: ${repr}`);
                await testViewer.setRepresentation(repr);
                updateStatus('control-status', `è¡¨ç¤ºæ–¹å¼å·²è®¾ç½®: ${repr}`, 'success');
            } catch (error) {
                log(`âŒ è®¾ç½®è¡¨ç¤ºæ–¹å¼å¤±è´¥: ${error.message}`);
                updateStatus('control-status', 'è®¾ç½®å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•é‡ç½®è§†å›¾
        async function testResetView() {
            if (!testViewer) {
                log('âŒ æŸ¥çœ‹å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                await testViewer.resetView();
                log('âœ… è§†å›¾å·²é‡ç½®');
                updateStatus('control-status', 'è§†å›¾å·²é‡ç½®', 'success');
            } catch (error) {
                log(`âŒ é‡ç½®è§†å›¾å¤±è´¥: ${error.message}`);
            }
        }
        
        // æµ‹è¯•ä¸‹è½½PDB
        async function testDownloadPDB() {
            if (!testViewer) {
                log('âŒ æŸ¥çœ‹å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                await testViewer.downloadPDB();
                log('âœ… PDBä¸‹è½½å·²å¼€å§‹');
                updateStatus('control-status', 'PDBä¸‹è½½å·²å¼€å§‹', 'success');
            } catch (error) {
                log(`âŒ ä¸‹è½½PDBå¤±è´¥: ${error.message}`);
            }
        }
        
        // æµ‹è¯•ä¸‹è½½å›¾ç‰‡
        async function testDownloadImage() {
            if (!testViewer) {
                log('âŒ æŸ¥çœ‹å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                await testViewer.downloadImage();
                log('âœ… å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹');
                updateStatus('control-status', 'å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹', 'success');
            } catch (error) {
                log(`âŒ ä¸‹è½½å›¾ç‰‡å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(() => {
                testLibraryLoad();
                testAPIConnection();
            }, 1000);
        });
    </script>
</body>
</html>
