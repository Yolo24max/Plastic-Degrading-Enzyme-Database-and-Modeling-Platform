<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蛋白质3D结构查看器测试 - PlaszymeDB</title>
    
    <!-- Mol* Library -->
    <script src="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.css">
    
    <!-- 蛋白质3D结构查看器 -->
    <script src="protein_3d_viewer.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #005eb8;
            margin-bottom: 15px;
        }
        .test-controls {
            margin-bottom: 20px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9em;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #e9ecef;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .viewer-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        .input-group label {
            font-weight: bold;
            min-width: 80px;
        }
        .input-group input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧬 蛋白质3D结构查看器测试</h1>
        
        <!-- 基础功能测试 -->
        <div class="test-section">
            <div class="test-title">1. 基础功能测试</div>
            <div class="test-controls">
                <button class="btn" onclick="testLibraryLoad()">检查Mol*库</button>
                <button class="btn" onclick="testAPIConnection()">测试API连接</button>
                <button class="btn success" onclick="initViewer()">初始化查看器</button>
                <button class="btn danger" onclick="destroyViewer()">销毁查看器</button>
            </div>
            <div class="status" id="basic-status">准备就绪</div>
        </div>

        <!-- 结构加载测试 -->
        <div class="test-section">
            <div class="test-title">2. 结构加载测试</div>
            <div class="test-controls">
                <div class="input-group">
                    <label>PLZ_ID:</label>
                    <input type="text" id="plz-input" value="00d4a4bfbe" placeholder="输入PLZ_ID">
                    <button class="btn success" onclick="loadTestStructure()">加载预测结构</button>
                    <button class="btn warning" onclick="loadExperimentalStructure()">加载实验结构</button>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="loadStructure('008a870d80')">测试 008a870d80</button>
                    <button class="btn" onclick="loadStructure('00fab94b93')">测试 00fab94b93</button>
                    <button class="btn" onclick="loadStructure('01681a8b2b')">测试 01681a8b2b</button>
                </div>
            </div>
            <div class="status" id="load-status">等待加载结构</div>
        </div>

        <!-- 查看器控制测试 -->
        <div class="test-section">
            <div class="test-title">3. 查看器控制测试</div>
            <div class="test-controls">
                <button class="btn" onclick="testRepresentation('cartoon')">卡通模式</button>
                <button class="btn" onclick="testRepresentation('surface')">表面模式</button>
                <button class="btn" onclick="testRepresentation('ball-stick')">球棍模式</button>
                <button class="btn" onclick="testResetView()">重置视图</button>
                <button class="btn" onclick="testDownloadPDB()">下载PDB</button>
                <button class="btn" onclick="testDownloadImage()">下载图片</button>
            </div>
            <div class="status" id="control-status">等待测试控制功能</div>
        </div>

        <!-- 3D结构查看器容器 -->
        <div class="viewer-container">
            <div id="protein-viewer-test" style="height: 600px;">
                <!-- 查看器将在这里初始化 -->
            </div>
        </div>

        <!-- 日志输出 -->
        <div class="test-section">
            <div class="test-title">4. 测试日志</div>
            <button class="btn danger" onclick="clearLog()">清除日志</button>
            <div class="log" id="test-log"></div>
        </div>
    </div>

    <script>
        let testViewer = null;
        
        // 日志记录
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // 更新状态
        function updateStatus(elementId, message, type = '') {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
        }
        
        // 测试Mol*库加载
        function testLibraryLoad() {
            log('测试Mol*库加载状态...');
            updateStatus('basic-status', '检查Mol*库...', 'loading');
            
            if (typeof window.molstar !== 'undefined') {
                log('✅ Mol*库已加载');
                updateStatus('basic-status', 'Mol*库已加载', 'success');
            } else {
                log('❌ Mol*库未加载');
                updateStatus('basic-status', 'Mol*库未加载', 'error');
            }
        }
        
        // 测试API连接
        async function testAPIConnection() {
            log('测试API连接...');
            updateStatus('basic-status', '测试API连接...', 'loading');
            
            try {
                const response = await fetch('api_protein_structure.php?plz_id=test&action=info');
                const data = await response.json();
                
                log(`✅ API连接正常: ${JSON.stringify(data)}`);
                updateStatus('basic-status', 'API连接正常', 'success');
            } catch (error) {
                log(`❌ API连接失败: ${error.message}`);
                updateStatus('basic-status', 'API连接失败', 'error');
            }
        }
        
        // 初始化查看器
        async function initViewer() {
            try {
                log('初始化3D结构查看器...');
                updateStatus('basic-status', '初始化查看器...', 'loading');
                
                if (testViewer) {
                    testViewer.destroy();
                    testViewer = null;
                }
                
                testViewer = new ProteinStructureViewer('protein-viewer-test', {
                    onLoadStart: (plzId, dataType) => {
                        log(`开始加载结构: ${plzId} (${dataType})`);
                        updateStatus('load-status', `加载中: ${plzId}`, 'loading');
                    },
                    onLoadComplete: (plzId, dataType, data) => {
                        log(`✅ 结构加载完成: ${plzId} (${dataType})`);
                        updateStatus('load-status', `加载完成: ${plzId}`, 'success');
                    },
                    onLoadError: (plzId, dataType, error) => {
                        log(`❌ 结构加载失败: ${plzId} (${dataType}) - ${error.message}`);
                        updateStatus('load-status', `加载失败: ${error.message}`, 'error');
                    },
                    onInit: (viewer) => {
                        log('✅ 3D结构查看器初始化完成');
                        updateStatus('basic-status', '查看器已初始化', 'success');
                    }
                });
                
            } catch (error) {
                log(`❌ 初始化失败: ${error.message}`);
                updateStatus('basic-status', '初始化失败', 'error');
            }
        }
        
        // 销毁查看器
        function destroyViewer() {
            if (testViewer) {
                testViewer.destroy();
                testViewer = null;
                log('查看器已销毁');
                updateStatus('basic-status', '查看器已销毁', '');
            } else {
                log('没有活动的查看器');
            }
        }
        
        // 加载测试结构
        async function loadTestStructure() {
            const plzId = document.getElementById('plz-input').value.trim();
            if (!plzId) {
                alert('请输入PLZ_ID');
                return;
            }
            await loadStructure(plzId, 'predicted');
        }
        
        // 加载实验结构
        async function loadExperimentalStructure() {
            const plzId = document.getElementById('plz-input').value.trim();
            if (!plzId) {
                alert('请输入PLZ_ID');
                return;
            }
            await loadStructure(plzId, 'experimental');
        }
        
        // 加载结构
        async function loadStructure(plzId, dataType = 'predicted') {
            if (!testViewer) {
                log('❌ 查看器未初始化，请先初始化');
                updateStatus('load-status', '查看器未初始化', 'error');
                return;
            }
            
            try {
                log(`加载结构: ${plzId} (${dataType})`);
                await testViewer.loadStructure(plzId, dataType);
            } catch (error) {
                log(`❌ 加载结构失败: ${error.message}`);
                updateStatus('load-status', `加载失败: ${error.message}`, 'error');
            }
        }
        
        // 测试表示方式
        async function testRepresentation(repr) {
            if (!testViewer) {
                log('❌ 查看器未初始化');
                updateStatus('control-status', '查看器未初始化', 'error');
                return;
            }
            
            try {
                log(`设置表示方式: ${repr}`);
                await testViewer.setRepresentation(repr);
                updateStatus('control-status', `表示方式已设置: ${repr}`, 'success');
            } catch (error) {
                log(`❌ 设置表示方式失败: ${error.message}`);
                updateStatus('control-status', '设置失败', 'error');
            }
        }
        
        // 测试重置视图
        async function testResetView() {
            if (!testViewer) {
                log('❌ 查看器未初始化');
                return;
            }
            
            try {
                await testViewer.resetView();
                log('✅ 视图已重置');
                updateStatus('control-status', '视图已重置', 'success');
            } catch (error) {
                log(`❌ 重置视图失败: ${error.message}`);
            }
        }
        
        // 测试下载PDB
        async function testDownloadPDB() {
            if (!testViewer) {
                log('❌ 查看器未初始化');
                return;
            }
            
            try {
                await testViewer.downloadPDB();
                log('✅ PDB下载已开始');
                updateStatus('control-status', 'PDB下载已开始', 'success');
            } catch (error) {
                log(`❌ 下载PDB失败: ${error.message}`);
            }
        }
        
        // 测试下载图片
        async function testDownloadImage() {
            if (!testViewer) {
                log('❌ 查看器未初始化');
                return;
            }
            
            try {
                await testViewer.downloadImage();
                log('✅ 图片下载已开始');
                updateStatus('control-status', '图片下载已开始', 'success');
            } catch (error) {
                log(`❌ 下载图片失败: ${error.message}`);
            }
        }
        
        // 清除日志
        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }
        
        // 页面加载完成后自动运行基本测试
        document.addEventListener('DOMContentLoaded', function() {
            log('测试页面加载完成');
            setTimeout(() => {
                testLibraryLoad();
                testAPIConnection();
            }, 1000);
        });
    </script>
</body>
</html>
