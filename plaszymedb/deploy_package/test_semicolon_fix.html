<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试分号修复 - PLZ_ID URL 编码</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
        }
        h2 {
            color: #34495e;
            margin-top: 0;
        }
        .test-case {
            background: #ecf0f1;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>🔧 PLZ_ID 分号编码修复测试</h1>
    
    <div class="info">
        <strong>问题描述：</strong> 数据库中某些 PLZ_ID 包含分号（如 <code>98b7748823;e79726b180</code>），
        在 URL 中需要正确编码为 <code>%3B</code>，否则会被截断。
    </div>

    <div class="test-section">
        <h2>测试用例</h2>
        
        <div class="test-case">
            <h3>1. X0002 - 带分号的 PLZ_ID</h3>
            <p><strong>PLZ_ID:</strong> <code>98b7748823;e79726b180</code></p>
            <button onclick="testApi('98b7748823;e79726b180', 'test1')">测试 API (info)</button>
            <button onclick="testPdbLoad('98b7748823;e79726b180', 'test1')">测试 PDB 加载</button>
            <div id="test1" class="result" style="display:none;"></div>
        </div>

        <div class="test-case">
            <h3>2. X0003 - 带分号的 PLZ_ID</h3>
            <p><strong>PLZ_ID:</strong> <code>60ea077c8e;8992bea4a0</code></p>
            <button onclick="testApi('60ea077c8e;8992bea4a0', 'test2')">测试 API (info)</button>
            <button onclick="testPdbLoad('60ea077c8e;8992bea4a0', 'test2')">测试 PDB 加载</button>
            <div id="test2" class="result" style="display:none;"></div>
        </div>

        <div class="test-case">
            <h3>3. X0009 - 多个分号的 PLZ_ID</h3>
            <p><strong>PLZ_ID:</strong> <code>bb22e38599;75d1d6dced;788e7e51f7</code></p>
            <button onclick="testApi('bb22e38599;75d1d6dced;788e7e51f7', 'test3')">测试 API (info)</button>
            <button onclick="testPdbLoad('bb22e38599;75d1d6dced;788e7e51f7', 'test3')">测试 PDB 加载</button>
            <div id="test3" class="result" style="display:none;"></div>
        </div>

        <div class="test-case">
            <h3>4. X0001 - 不带分号的 PLZ_ID (对照组)</h3>
            <p><strong>PLZ_ID:</strong> <code>866554aa77</code></p>
            <button onclick="testApi('866554aa77', 'test4')">测试 API (info)</button>
            <button onclick="testPdbLoad('866554aa77', 'test4')">测试 PDB 加载</button>
            <div id="test4" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>URL 编码对比</h2>
        <div id="encoding-demo"></div>
    </div>

    <script>
        // 显示编码对比
        function showEncodingDemo() {
            const testIds = [
                '98b7748823;e79726b180',
                '60ea077c8e;8992bea4a0',
                'bb22e38599;75d1d6dced;788e7e51f7',
                '866554aa77'
            ];
            
            let html = '<table style="width:100%; border-collapse: collapse;">';
            html += '<tr style="background: #34495e; color: white;"><th style="padding:10px; text-align:left;">原始 PLZ_ID</th><th style="padding:10px; text-align:left;">编码后</th></tr>';
            
            testIds.forEach((id, i) => {
                const encoded = encodeURIComponent(id);
                const bg = i % 2 === 0 ? '#ecf0f1' : 'white';
                html += `<tr style="background: ${bg};">
                    <td style="padding:10px; font-family: monospace;">${id}</td>
                    <td style="padding:10px; font-family: monospace; color: #27ae60;">${encoded}</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('encoding-demo').innerHTML = html;
        }

        // 测试 API info 端点
        async function testApi(plzId, resultId) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '测试中...';
            
            try {
                // 使用 encodeURIComponent 编码 PLZ_ID
                const encodedId = encodeURIComponent(plzId);
                const url = `api_protein_structure.php?plz_id=${encodedId}&type=predicted&action=info`;
                
                resultDiv.textContent = `请求 URL:\n${url}\n\n正在加载...`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 失败\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ 成功!\n\nPLZ_ID: ${data.plz_id}\nXID: ${data.xid}\nPDB 存在: ${data.files?.pdb_exists}\nJSON 存在: ${data.files?.json_exists}\n\n完整响应:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 错误: ${error.message}`;
            }
        }

        // 测试 PDB 文件加载
        async function testPdbLoad(plzId, resultId) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '加载 PDB 文件...';
            
            try {
                // 使用 encodeURIComponent 编码 PLZ_ID
                const encodedId = encodeURIComponent(plzId);
                const url = `api_protein_structure.php?plz_id=${encodedId}&type=predicted&action=pdb`;
                
                resultDiv.textContent = `请求 URL:\n${url}\n\n正在加载...`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                if (response.ok && text.startsWith('HEADER')) {
                    // 成功加载 PDB
                    const lines = text.split('\n');
                    const preview = lines.slice(0, 10).join('\n');
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ PDB 文件加载成功!\n\n文件大小: ${text.length} 字节\n总行数: ${lines.length}\n\n前10行:\n${preview}`;
                } else {
                    // 尝试解析为 JSON（可能是错误消息）
                    try {
                        const error = JSON.parse(text);
                        resultDiv.className = 'result error';
                        resultDiv.textContent = `❌ 失败\n\n${JSON.stringify(error, null, 2)}`;
                    } catch {
                        resultDiv.className = 'result error';
                        resultDiv.textContent = `❌ 失败\n\nHTTP ${response.status}\n\n${text.substring(0, 500)}`;
                    }
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 错误: ${error.message}`;
            }
        }

        // 页面加载时显示编码对比
        showEncodingDemo();
    </script>
</body>
</html>

