# PlaszymeDB 结构数据配置说明

## 📁 目录结构

所有蛋白质3D结构数据现已统一存放在 `structure_data` 文件夹中：

```
C:\xampp\htdocs\plaszymedb\structure_data\
├── predicted_xid/              # 预测结构数据
│   ├── pdb/                    # 474个PDB文件 (X0001.pdb - X0474.pdb)
│   ├── json/                   # 474个JSON元数据文件
│   ├── pred_metadata_XID.csv   # 预测数据元数据和映射
│   ├── PLZ_XID.csv            # PLZ_ID到XID完整映射
│   └── PlaszymeDB_v1.csv      # 完整数据集
│
└── experimental_xid/           # 实验结构数据
    ├── pdb/                    # 33个实验PDB文件 (XID命名)
    ├── json/                   # JSON元数据文件
    └── exp_metadata_XID.csv   # 实验数据元数据和映射
```

---

## 🔑 关键概念

### PLZ_ID vs XID

- **PLZ_ID**: PlaszymeDB内部唯一标识符 (10位哈希，如 `866554aa77`)
  - 数据库中的主键
  - 前端用于搜索和显示
  - URL参数使用PLZ_ID

- **XID**: 蛋白质序列标识符 (如 `X0001`, `X0002`)
  - PDB文件命名使用XID
  - 与外部数据源对应
  - 便于人类识别

### 映射关系

API会自动从metadata文件中读取PLZ_ID到XID的映射：

- 预测数据: `pred_metadata_XID.csv`
- 实验数据: `exp_metadata_XID.csv`

---

## 🔧 已修改的文件

### 1. `api_protein_structure.php`

**主要修改:**

#### a) 更新路径配置
```php
// 旧路径（已废弃）
$pdb_dir = $base_path . '/pdb_predicted/pdb/';

// 新路径
$pdb_dir = $base_path . '/structure_data/predicted_xid/pdb/';
```

#### b) 添加PLZ_ID到XID映射函数
```php
function loadPlzToXidMapping($csvPath) {
    // 从CSV文件加载映射关系
    // 使用静态缓存提高性能
}
```

#### c) 使用XID访问文件
```php
// 加载映射
$mapping = loadPlzToXidMapping($metadata_csv);
$xid = $mapping[$plz_id];

// 使用XID构建文件路径
$pdb_file = $pdb_dir . $xid . '.pdb';
```

---

## 📊 Metadata文件格式

### 预测数据 (`pred_metadata_XID.csv`)

| 字段 | 说明 | 示例 |
|------|------|------|
| PLZ_ID | PlaszymeDB ID | 866554aa77 |
| protein_id | XID标识符 | X0001 |
| pLDDT | 预测置信度 | 97.7 |
| pTM | TM-score | 0.95 |
| pdb_path | PDB相对路径 | pdb/X0001.pdb |
| json_path | JSON相对路径 | json/X0001.json |

### 实验数据 (`exp_metadata_XID.csv`)

| 字段 | 说明 | 示例 |
|------|------|------|
| PLZ_ID | PlaszymeDB ID | bd7ef0ab46 |
| protein_id | XID标识符 | X0223 |
| pdb_id | PDB数据库ID | 8AIR |
| structure_source | 数据来源 | RCSB_PDB |
| structure_method | 实验方法 | X-RAY DIFFRACTION |
| resolution | 分辨率 | 1.08 Å |
| pdb_path | PDB相对路径 | pdb/X0223.pdb |
| json_path | JSON相对路径 | json/X0223.json |

---

## 🚀 API使用方法

### 1. 获取结构信息

```
GET api_protein_structure.php?plz_id=866554aa77&type=predicted&action=info
```

**参数:**
- `plz_id`: PLZ_ID标识符 (必需)
- `type`: 数据类型 `predicted` 或 `experimental` (默认: `predicted`)
- `action`: 操作类型 `info` | `pdb` | `json` (默认: `info`)

**响应示例:**
```json
{
  "plz_id": "866554aa77",
  "xid": "X0001",
  "data_type": "predicted",
  "files": {
    "pdb_exists": true,
    "json_exists": true,
    "pdb_path": "api_protein_structure.php?plz_id=866554aa77&type=predicted&action=pdb",
    "json_path": "api_protein_structure.php?plz_id=866554aa77&type=predicted&action=json",
    "pdb_file_path": "C:/xampp/htdocs/plaszymedb/structure_data/predicted_xid/pdb/X0001.pdb",
    "json_file_path": "C:/xampp/htdocs/plaszymedb/structure_data/predicted_xid/pdb/X0001.json"
  },
  "enzyme_info": {
    "enzyme_name": "Enzyme 702",
    "ec_number": null,
    "pdb_ids": "7QJQ"
  }
}
```

### 2. 下载PDB文件

```
GET api_protein_structure.php?plz_id=866554aa77&type=predicted&action=pdb
```

直接返回PDB文件内容，文件名为 `X0001.pdb`

### 3. 获取JSON元数据

```
GET api_protein_structure.php?plz_id=866554aa77&type=predicted&action=json
```

返回结构的JSON元数据（如pLDDT、pTM等）

---

## 🧪 测试方法

### 快速测试

在浏览器中打开测试页面：
```
http://localhost/plaszymedb/test_structure_api.php
```

该测试页面会自动执行以下检查：
- ✅ 目录结构完整性
- ✅ Metadata文件存在性
- ✅ PLZ_ID到XID映射
- ✅ API调用功能
- ✅ PDB文件可访问性

### 手动测试

#### 测试预测结构
```bash
# 获取信息
curl "http://localhost/plaszymedb/api_protein_structure.php?plz_id=866554aa77&type=predicted&action=info"

# 下载PDB
curl "http://localhost/plaszymedb/api_protein_structure.php?plz_id=866554aa77&type=predicted&action=pdb" -o test.pdb
```

#### 测试实验结构
```bash
# 获取信息
curl "http://localhost/plaszymedb/api_protein_structure.php?plz_id=bd7ef0ab46&type=experimental&action=info"

# 下载PDB
curl "http://localhost/plaszymedb/api_protein_structure.php?plz_id=bd7ef0ab46&type=experimental&action=pdb" -o test_exp.pdb
```

---

## 📈 性能优化

### 映射缓存

`loadPlzToXidMapping()` 函数使用静态缓存：
```php
static $cache = [];
```

同一请求中多次调用不会重复读取CSV文件，提高性能。

### 文件访问

- PDB文件直接使用 `readfile()` 流式传输
- 不会将整个文件加载到内存
- 适合大型PDB文件

---

## ⚠️ 常见问题

### Q1: 为什么要使用XID而不是PLZ_ID命名文件？

**A:** 
- XID更简短易读 (`X0001` vs `866554aa77`)
- 与外部数据源保持一致
- 便于手动管理和检查文件

### Q2: 如果metadata文件缺失会怎样？

**A:** API会返回错误：
```json
{
  "error": true,
  "message": "未找到PLZ_ID 'xxx' 对应的结构数据"
}
```

### Q3: 预测结构和实验结构有什么区别？

**A:**
- **预测结构**: AlphaFold等工具预测，包含pLDDT和pTM指标
- **实验结构**: X-ray/NMR等实验获得，包含分辨率和PDB ID

### Q4: 前端如何选择使用哪种类型的结构？

**A:** 前端根据可用性自动选择：
1. 优先使用实验结构（如果存在）
2. 否则使用预测结构
3. 用户可手动切换

---

## 🔄 数据更新流程

如果需要添加新的结构数据：

1. **添加PDB文件**
   ```bash
   # 预测结构
   structure_data/predicted_xid/pdb/X0475.pdb
   
   # 实验结构
   structure_data/experimental_xid/pdb/X0475.pdb
   ```

2. **更新metadata CSV**
   - 在对应的CSV文件中添加新行
   - 包含PLZ_ID、XID和其他元数据

3. **清除缓存**
   - 重启PHP进程或重新加载页面
   - 静态缓存会自动刷新

---

## 📝 代码示例

### 前端JavaScript调用

```javascript
// 加载预测结构
async function loadStructure(plzId) {
    const apiUrl = `api_protein_structure.php?plz_id=${plzId}&type=predicted&action=pdb`;
    const response = await fetch(apiUrl);
    const pdbText = await response.text();
    
    // 使用Mol*加载结构
    // ... (见protein_viewer_optimized.js)
}

// 获取结构信息
async function getStructureInfo(plzId, type = 'predicted') {
    const apiUrl = `api_protein_structure.php?plz_id=${plzId}&type=${type}&action=info`;
    const response = await fetch(apiUrl);
    const info = await response.json();
    
    console.log('XID:', info.xid);
    console.log('PDB exists:', info.files.pdb_exists);
}
```

### PHP后端调用

```php
// 获取某个酶的结构信息
$plz_id = '866554aa77';
$url = "http://localhost/plaszymedb/api_protein_structure.php?plz_id={$plz_id}&type=predicted&action=info";
$response = file_get_contents($url);
$data = json_decode($response, true);

if ($data['files']['pdb_exists']) {
    echo "找到结构文件: " . $data['xid'];
}
```

---

## 🎯 总结

### 修改前后对比

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 目录路径 | `pdb_predicted/` | `structure_data/predicted_xid/` |
| 文件命名 | PLZ_ID | XID |
| 映射机制 | 无 | CSV metadata文件 |
| 缓存策略 | 无 | 静态缓存 |
| 错误信息 | 简单 | 详细（包含PLZ_ID、XID、路径） |

### 主要优势

✅ **统一管理**: 所有结构数据集中在 `structure_data` 文件夹  
✅ **清晰命名**: 使用XID使文件更易识别  
✅ **灵活映射**: 支持PLZ_ID到XID的自动转换  
✅ **高性能**: 映射缓存减少重复读取  
✅ **易维护**: 通过CSV文件管理映射关系  
✅ **向后兼容**: API接口保持不变，只需传入PLZ_ID

---

## 📞 支持

如有问题，请检查：
1. 目录权限是否正确
2. metadata CSV文件格式是否正确
3. PDB文件是否存在
4. 访问 `test_structure_api.php` 查看详细诊断信息

---

*最后更新: 2025-10-08*

