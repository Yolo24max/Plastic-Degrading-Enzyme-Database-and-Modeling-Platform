<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mol*加载修复测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        #viewer-container {
            margin-top: 20px;
            height: 500px;
            border: 1px solid #ccc;
        }
    </style>
    <!-- Mol*库 -->
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/molstar@latest/build/viewer/molstar.css" />
    <script type="text/javascript" src="https://unpkg.com/molstar@latest/build/viewer/molstar.js"></script>
</head>
<body>
    <div class="container">
        <h1>Mol*加载修复测试</h1>
        <p>测试修复后的PDB加载功能</p>
        
        <div class="test-section">
            <h3>1. API连接测试</h3>
            <button class="test-button" onclick="testApiConnection()">测试API连接</button>
            <div id="api-result" class="test-result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. PDB文件获取测试</h3>
            <button class="test-button" onclick="testPdbFetch()">获取PDB文件</button>
            <div id="pdb-result" class="test-result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. Mol*查看器初始化测试</h3>
            <button class="test-button" onclick="testMolstarInit()">初始化Mol*查看器</button>
            <div id="molstar-result" class="test-result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. 完整加载测试</h3>
            <button class="test-button" onclick="testCompleteLoad()">完整加载测试</button>
            <div id="complete-result" class="test-result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. 3D查看器</h3>
            <div id="viewer-container"></div>
        </div>
    </div>

    <script>
        let molstarViewer = null;
        const testPlzId = '01681a8b2b';
        
        // 测试API连接
        async function testApiConnection() {
            const resultDiv = document.getElementById('api-result');
            try {
                resultDiv.className = 'test-result info';
                resultDiv.textContent = '正在测试API连接...';
                
                const response = await fetch(`api_protein_structure.php?plz_id=${testPlzId}&type=predicted&action=info`);
                const data = await response.json();
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `API连接成功!\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `API连接失败: ${error.message}`;
            }
        }
        
        // 测试PDB文件获取
        async function testPdbFetch() {
            const resultDiv = document.getElementById('pdb-result');
            try {
                resultDiv.className = 'test-result info';
                resultDiv.textContent = '正在获取PDB文件...';
                
                const url = `api_protein_structure.php?plz_id=${testPlzId}&type=predicted&action=pdb`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} - ${response.statusText}`);
                }
                
                const pdbText = await response.text();
                
                if (!pdbText || pdbText.trim().length === 0) {
                    throw new Error('PDB文件内容为空');
                }
                
                // 验证PDB格式
                if (!pdbText.includes('ATOM') && !pdbText.includes('HETATM')) {
                    throw new Error('无效的PDB格式 - 缺少ATOM或HETATM记录');
                }
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `PDB文件获取成功!\n大小: ${pdbText.length} 字节\n前100个字符:\n${pdbText.substring(0, 100)}...`;
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `PDB文件获取失败: ${error.message}`;
            }
        }
        
        // 测试Mol*查看器初始化
        async function testMolstarInit() {
            const resultDiv = document.getElementById('molstar-result');
            try {
                resultDiv.className = 'test-result info';
                resultDiv.textContent = '正在初始化Mol*查看器...';
                
                // 等待Mol*库加载
                if (typeof window.molstar === 'undefined') {
                    throw new Error('Mol*库未加载');
                }
                
                const container = document.getElementById('viewer-container');
                container.innerHTML = '';
                
                molstarViewer = await window.molstar.Viewer.create(container, {
                    layoutIsExpanded: false,
                    layoutShowControls: false,
                    layoutShowRemoteState: false,
                    layoutShowSequence: true,
                    layoutShowLog: false,
                    layoutShowLeftPanel: false,
                    viewportShowExpand: false,
                    viewportShowSelectionMode: false,
                    viewportShowAnimation: false,
                });
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = 'Mol*查看器初始化成功!';
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `Mol*查看器初始化失败: ${error.message}`;
            }
        }
        
        // 完整加载测试
        async function testCompleteLoad() {
            const resultDiv = document.getElementById('complete-result');
            try {
                resultDiv.className = 'test-result info';
                resultDiv.textContent = '正在进行完整加载测试...';
                
                if (!molstarViewer) {
                    throw new Error('请先初始化Mol*查看器');
                }
                
                const url = `api_protein_structure.php?plz_id=${testPlzId}&type=predicted&action=pdb`;
                
                // 获取PDB数据
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} - ${response.statusText}`);
                }
                
                const pdbText = await response.text();
                if (!pdbText || pdbText.trim().length === 0) {
                    throw new Error('PDB文件内容为空');
                }
                
                // 验证PDB格式
                if (!pdbText.includes('ATOM') && !pdbText.includes('HETATM')) {
                    throw new Error('无效的PDB格式 - 缺少ATOM或HETATM记录');
                }
                
                resultDiv.textContent += '\nPDB数据获取成功，开始加载到Mol*...';
                
                // 使用Mol*的正确API加载结构
                const plugin = molstarViewer.plugin;
                
                // 清除现有结构
                await plugin.clear();
                
                // 创建数据源
                const data = await plugin.builders.data.rawData({
                    data: pdbText,
                    label: `${testPlzId}.pdb`
                });
                
                // 解析PDB格式
                const trajectory = await plugin.builders.structure.parseTrajectory(data, 'pdb');
                
                // 创建模型
                const model = await plugin.builders.structure.createModel(trajectory);
                
                // 创建结构
                const structure = await plugin.builders.structure.createStructure(model);
                
                // 验证结构是否创建成功
                if (!structure || !structure.cell || !structure.cell.obj) {
                    throw new Error('结构创建失败');
                }
                
                // 添加默认表示方式
                await plugin.builders.structure.representation.addRepresentation(structure, {
                    type: 'cartoon',
                    colorTheme: { name: 'chain-id' },
                    sizeTheme: { name: 'uniform' }
                });
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = `完整加载测试成功!\n结构已显示在3D查看器中。\nPDB大小: ${pdbText.length} 字节`;
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `完整加载测试失败: ${error.message}\n\n错误详情: ${error.stack}`;
            }
        }
        
        // 页面加载时检查Mol*库
        window.addEventListener('load', () => {
            if (typeof window.molstar === 'undefined') {
                console.warn('Mol*库未加载，请检查网络连接');
            } else {
                console.log('Mol*库加载成功');
            }
        });
    </script>
</body>
</html>
