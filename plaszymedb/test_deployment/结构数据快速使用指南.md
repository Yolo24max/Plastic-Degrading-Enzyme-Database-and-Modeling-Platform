# PlaszymeDB 结构数据快速使用指南

## 🎯 修改完成！

您的PlaszymeDB现已配置为从新的 `structure_data` 文件夹加载3D结构数据。

---

## 📍 新的目录结构

```
C:\xampp\htdocs\plaszymedb\
└── structure_data\
    ├── predicted_xid\          # ← 预测结构 (474个)
    │   ├── pdb\                # X0001.pdb - X0474.pdb
    │   ├── json\               # 元数据
    │   └── pred_metadata_XID.csv  # PLZ_ID → XID 映射
    │
    └── experimental_xid\       # ← 实验结构 (33个)
        ├── pdb\                # X0001.pdb, X0008.pdb, etc.
        ├── json\               # 元数据
        └── exp_metadata_XID.csv  # PLZ_ID → XID 映射
```

---

## 🚀 立即测试

### 方法1：打开测试页面（推荐）

在浏览器中访问：

```
http://localhost/plaszymedb/test_3d_viewer.html
```

这个页面提供了：
- ✅ 交互式3D查看器
- ✅ 预置的测试样例
- ✅ 实时API检查
- ✅ 完整的错误提示

**快速操作：**
1. 点击任意"快速测试示例"按钮
2. 等待3D结构加载
3. 查看结构是否正常显示

---

### 方法2：API测试页面

在浏览器中访问：

```
http://localhost/plaszymedb/test_structure_api.php
```

这个页面会检查：
- ✅ 目录结构是否正确
- ✅ Metadata文件是否存在
- ✅ API是否正常工作
- ✅ PDB文件是否可访问

---

### 方法3：直接测试API

在浏览器中打开以下链接：

**预测结构测试：**
```
http://localhost/plaszymedb/api_protein_structure.php?plz_id=866554aa77&type=predicted&action=info
```

**实验结构测试：**
```
http://localhost/plaszymedb/api_protein_structure.php?plz_id=bd7ef0ab46&type=experimental&action=info
```

**期望响应：**
```json
{
  "plz_id": "866554aa77",
  "xid": "X0001",
  "data_type": "predicted",
  "files": {
    "pdb_exists": true,
    "json_exists": true,
    ...
  }
}
```

---

## 🔑 关键改动

### 1. API路径更新

**之前:**
```php
$pdb_dir = $base_path . '/pdb_predicted/pdb/';
```

**现在:**
```php
$pdb_dir = $base_path . '/structure_data/predicted_xid/pdb/';
```

### 2. PLZ_ID → XID 映射

API现在会自动：
1. 从CSV文件读取映射关系
2. 将PLZ_ID转换为XID
3. 使用XID访问PDB文件

**示例：**
- 用户请求: `PLZ_ID = 866554aa77`
- API查找: `XID = X0001`
- 加载文件: `X0001.pdb`

### 3. 前端无需修改

前端代码（`protein_viewer_optimized.js`）**无需修改**！

原因：
- 前端仍然使用PLZ_ID调用API
- API内部处理PLZ_ID到XID的转换
- 对前端完全透明

---

## 📝 在主页面中测试

### 打开V9.html

```
http://localhost/plaszymedb/V9.html
```

### 测试步骤

1. **搜索酶**
   - 在搜索框输入任意关键词
   - 或直接点击DATABASE标签查看所有酶

2. **打开详情页**
   - 点击任意酶的"View Details"按钮

3. **查看3D结构**
   - 点击"3D Structure"标签
   - 等待结构加载
   - 尝试切换表示方式（Cartoon/Ball-Stick/Surface）

4. **验证功能**
   - ✅ 结构应该正常显示
   - ✅ 可以旋转、缩放
   - ✅ 切换表示方式无错误
   - ✅ 控制台无500错误

---

## ⚙️ 修改的文件

### 主要文件

1. **api_protein_structure.php** ✅
   - 添加了 `loadPlzToXidMapping()` 函数
   - 更新了路径为 `structure_data/`
   - 增强了错误信息

### 测试文件

2. **test_structure_api.php** ✅ 新建
   - 后端API功能测试

3. **test_3d_viewer.html** ✅ 新建
   - 前端3D查看器测试

### 文档文件

4. **结构数据配置说明.md** ✅ 新建
   - 完整的技术文档

5. **结构数据快速使用指南.md** ✅ 新建（本文件）
   - 快速上手指南

---

## 🎨 测试用的样例数据

### 预测结构样例

| PLZ_ID | XID | 酶名 |
|--------|-----|------|
| 866554aa77 | X0001 | Enzyme 702 |
| 0c1b4dd3c4 | X0004 | Proteinase K |
| 9a48d1ff76 | X0005 | SIBER-1 |

### 实验结构样例

| PLZ_ID | XID | PDB ID | 分辨率 |
|--------|-----|--------|--------|
| bd7ef0ab46 | X0223 | 8AIR | 1.08 Å |
| ba04d67a0c | X0321 | 6SBN | 1.09 Å |
| 2cbb6fa0a4 | X0200 | 1AGY | 1.15 Å |

---

## ❓ 常见问题

### Q: 为什么看不到3D结构？

**检查清单：**
1. ✓ 打开浏览器控制台查看错误
2. ✓ 访问 `test_structure_api.php` 检查文件是否存在
3. ✓ 确认 `structure_data` 文件夹在正确位置
4. ✓ 检查文件权限

### Q: API返回"未找到PLZ_ID对应的结构数据"

**可能原因：**
1. 该PLZ_ID在metadata CSV中不存在
2. metadata文件路径错误
3. CSV文件格式问题

**解决方法：**
- 打开对应的metadata CSV文件
- 搜索该PLZ_ID是否存在
- 检查CSV格式是否正确（有PLZ_ID和protein_id列）

### Q: PDB文件存在但加载失败

**可能原因：**
1. PDB文件格式错误
2. 文件路径权限问题
3. 浏览器缓存问题

**解决方法：**
1. 直接访问PDB下载链接测试
2. 检查文件是否可读
3. 清除浏览器缓存（Ctrl+Shift+R）

---

## 🔧 高级配置

### 添加新结构

如果您需要添加新的结构文件：

1. **添加PDB文件**
   ```
   structure_data/predicted_xid/pdb/X0475.pdb
   ```

2. **更新metadata CSV**
   在 `pred_metadata_XID.csv` 添加：
   ```
   新的PLZ_ID,X0475,pLDDT值,pTM值,pdb/X0475.pdb,json/X0475.json
   ```

3. **刷新缓存**
   - 重新加载页面
   - 或重启Apache

### 性能优化

API已内置缓存机制：
- CSV映射在同一请求中只读取一次
- 使用静态变量缓存
- 无需额外配置

---

## 📞 需要帮助？

如果遇到问题：

1. **查看控制台错误**
   - 按F12打开开发者工具
   - 查看Console和Network标签

2. **运行诊断测试**
   ```
   http://localhost/plaszymedb/test_structure_api.php
   ```

3. **检查详细文档**
   - 阅读 `结构数据配置说明.md`
   - 查看API源码 `api_protein_structure.php`

---

## ✅ 完成！

您的PlaszymeDB现在可以：

✅ 从 `structure_data` 文件夹加载结构  
✅ 自动处理PLZ_ID到XID的映射  
✅ 支持预测和实验两种结构类型  
✅ 缓存映射数据以提高性能  
✅ 提供详细的错误信息  

**立即测试：** [http://localhost/plaszymedb/test_3d_viewer.html](http://localhost/plaszymedb/test_3d_viewer.html)

---

*最后更新: 2025-10-08*

